trigger:
- main

variables:
  vmConnectionName: 'bookstore2'
  vmIpAddress: '40.76.124.247'
  projectName: 'BookStore'
  deployPath: '/home/azureuser/BookStore1/gitrepo/BookStore'

stages:
- stage: Deploy
  jobs:
  - deployment: DeployToVM
    environment: 'Production'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: SSH@0
            inputs:
              sshEndpoint: '$(vmConnectionName)'
              runOptions: 'inline'
              inline: |
                if [ ! -d "$(deployPath)" ]; then
                  echo "Directory does not exist. Creating..."
                  sudo mkdir -p $(deployPath)
                fi
                
                sudo chmod -R 755 $(deployPath)
                sudo git config --global --add safe.directory $(deployPath)
                
                cd $(deployPath)
                
                if [ ! -d ".git" ]; then
                  echo "Git repository not found. Initializing..."
                  git init
                  git remote add origin YOUR_REPO_URL
                fi
                
                git pull origin main
                dotnet restore
                dotnet build --configuration Release
                dotnet run --configuration Release
              failOnStderr: false